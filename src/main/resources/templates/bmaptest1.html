<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <title>bmaptest</title>

    <link href="/traceroot/css/style.css" rel="stylesheet" type="text/css">

    <link href="https://cdn.bootcss.com/font-awesome/5.8.0/css/all.css" rel="stylesheet" />

    <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=nBKX588I9lDCyaKBip9bQTpmeeCidwL3">

        //v2.0版本的引用方式：src="http://api.map.baidu.com/api?v=2.0&ak=您的密钥"

    </script>



    <script src="/traceroot/js/echarts.min.js"></script>

    <script src="/traceroot/js/echarts-liquidfill.min.js "></script>

    <script type="text/javascript" src="/traceroot/js/changec.js"></script>

    <script type="text/javascript" src="/traceroot/js/jquery-3.3.1.js"></script>

    <script src="/traceroot/js/transdata.js"></script>

    <script>
        function getvalue()
    {
        var pare=window.opener;
        if(pare!=null)
        {

            var start=new Array();
            var end=new Array();
            var update=new Array();
            var creat=new Array();
            var sensorid=new Array();
            var sensorlocation=new Array();
            var sensortype=new Array();
            var sensorstate=new Array();
            var sensorvalue=new Array();
            var sensorupdate=new Array();
            var sensorcreat=new Array();
            var tablepipesegment=pare.document.getElementById("pipesegment1");
            var tablesensor=pare.document.getElementById("sensor1");

           for (i = 0; i < tablepipesegment.rows.length -1; i++) {
                start[i] = tablepipesegment.rows[i+1].cells[1];
                end[i] = tablepipesegment.rows[i+1].cells[2];
                update[i] = tablepipesegment.rows[i+1].cells[3];
                creat[i] = tablepipesegment.rows[i+1].cells[4];
                if (end[i] != null) {

                    drawpipe(start[i], end[i]);

                }
            }


            for (j = 0; j <  tablesensor.rows.length -1; j++) {
                sensorid[j] = tablesensor.rows[j+1].cells[0];
                sensorlocation[j] = tablesensor.rows[j+1].cells[1];
                sensortype[j]= tablesensor.rows[j+1].cells[2];
                sensorstate[j]= tablesensor.rows[j+1].cells[3];
                sensorvalue[j]= tablesensor.rows[j+1].cells[4];
                sensorupdate[j]= tablesensor.rows[j+1].cells[5];
                sensorcreat[j]= tablesensor.rows[j+1].cells[6];
                if (sensorlocation[j] != null) {
                    drawsensor(sensorid[j],sensorlocation[j],sensortype[j],sensorstate[j],sensorvalue[j],sensorupdate[j],sensorcreat[j]);

                }
            }
        }
    }
    </script>
    </head>



<body onload="getvalue()" >

<div style="position:relative; width:100%; height:100%;" id="container"></div>

<div id="middle" class="middle">					<!--loading效果-->



    <div class="bar bar1"></div>



    <div class="bar bar2"></div>



    <div class="bar bar3"></div>



    <div class="bar bar4"></div>



    <div class="bar bar5"></div>



    <div class="bar bar6"></div>



    <div class="bar bar7"></div>



    <div class="bar bar8"></div>



</div>

<div id="navigator">

    <div class="has_children">

        <li onclick=change(0)>管道线路管理</li>

        <li onclick=change(1)>渤海</li>

        <li onclick=change(2)>黄海</li>

        <li onclick=change(3)>东海</li>

        <li onclick=change(4)>南海</li>

        <li onclick=change(5)>城市管道</li>

    </div>

    <!--<div id="boat" class="has_children">

    <span>船只轨迹监测</span>

     <li onclick=change(6)></li>

     <li onclick=change(7)></li>

     <li onclick=change(8)></li>

    </div> -->

    <div id="echarts" style="width:100%;height:70%;">

    </div>

</div>

<div id="drag">

    <p>告警管道id</p>

    <div id="dragon" class="dragon">

        <p>aaa</p>

        <!--根据告警管道的个数决定显示多少个p-->

    </div>

</div>

<div id="liquid" >

    <div class="liquid">

        <table cellspacing="1" cellpadding="3" width="30%" style="color: beige" >

            <tr>

                <td>经度</td>

                <td><input type="text" name="lng" id="lng" value=""/>

                </td>

            </tr>

            <tr>

                <td >纬度</td>

                <td><input type="text" name="lat" id="lat" value=""/>

                </td>

            </tr>

            <tr>

                <td >管道id</td>

                <td><input type="text" name="id" id="id" value=""/>

                </td>

            </tr>

        </table>
        <input type="button" onclick="jump()" value="跳转">

    </div>

    <div id="liquid1" class="liquid" ></div>

    <div id="liquid2" class="liquid" ></div>

    <div id="liquid3" class="liquid" ></div>

    <div id="liquid4" class="liquid" ></div>

    <div class="liquid" name="pipesegment" id="pipesegment">
        <table cellspacing="1" cellpadding="2" width="60%" style="color: beige" >

            <tr  >
                <td>更新时间</td>
                <td><input type="text"   name="pipesegmentstart" id="pipesegmentstart" />
                </td>
            </tr>
            <tr >
                <td>创建时间</td>
                <td><input type="text" name="pipesegmentend" id="pipesegmentend" />
                </td>
            </tr>
        </table>
    </div>

</div>

<div id="button">
    <button style="font-size:24px">新建 <i class="fa fa-plus-square" onclick="addp()"></i></button>
    <button style="font-size:24px">删除 <i class="fa fa-minus-square" onclick="delp()"></i></button>
</div>

<div id="r-result"></div>

<script type="text/javascript">

    // 基于准备好的dom，初始化echarts实例

    echarts.init(document.getElementById('echarts')).setOption({

        title: {

            text: 'ECharts test'

        },

        tooltip: {},

        legend: {

            data:['销量']

        },

        xAxis: {

            data: ["正常管道","告警管道"],

            axisLine:{

                lineStyle:{

                    color:'yellow',					 //设置坐标轴字体颜色

                }

            }

        },

        yAxis: {



            axisLine:{

                lineStyle:{

                    color:'yellow',					 //设置坐标轴字体颜色

                }

            }

        },



        series: [{

            name: '管道',

            type: 'bar',

            itemStyle:{ normal:{color:'blue'}},							 //设置柱状图颜色

            data: [20,5]												//此处需要告警管道的个数

        }]

    });

</script>

<script type="text/javascript">	 //管道参数数据显示

function x(infoWindow) {
    var x = new Array();   //管道参数数据

    var sensordata = infoWindow.getContent();

    var sensorvalue =sensordata.split("；");

    var senid = sensorvalue[0].split("：");

    var location  = sensorvalue[1].split("：");

    var pos  = location[1].split(",");

    var updatet=sensorvalue[5].split("：");

    var creatt=sensorvalue[6].split("：");

    var svalue=sensorvalue[4].split("：");

    var stype=sensorvalue[3].split("：");

    document.getElementById('lng').value = pos[0];

    document.getElementById('lat').value = pos[1];

    document.getElementById('id').value = senid[1];

    document.getElementById("pipesegmentstart").value=updatet[1];

    document.getElementById("pipesegmentend").value=creatt[1];

    var s = parseFloat(svalue[1]);

    var st = parseFloat(stype[1]);

    switch (st) {
        case 2926155 :
            x[0] = [s];
            x[1] = [0];
            x[2] = [0];
            x[3] = [0];
            break;
        case 2926378 :
            x[0] = [0];
            x[1] = [s];
            x[2] = [0];
            x[3] = [0];
            break;
        case 7752109 :
            x[0] = [0];
            x[1] = [0];
            x[2] = [s];
            x[3] = [0];
            break;
        default :
            x[0] = [0];
            x[1] = [0];
            x[2] = [0];
            x[3] = [0.4];
            break;

    }











    echarts.init(document.getElementById('liquid1')).setOption({


        series: {

            type: 'liquidFill',

            data: x[0],

            name: "线路负载",

            label: {


                position: ['50%', '50%'],

                formatter: '{a}\n{b}\n{c}',

                fontSize: 20


            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'


                }

            }

        }


    });

    echarts.init(document.getElementById('liquid2')).setOption({


        series: {

            type: 'liquidFill',

            data: x[1],

            name: "温度相对值",

            label: {


                position: ['50%', '50%'],

                formatter: '{a}\n\n{c}',			//{a} refers to series name, {b} to data name, and {c} to data value.

                fontSize: 20


            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'


                }

            }

        }


    });

    echarts.init(document.getElementById('liquid3')).setOption({


        series: {

            type: 'liquidFill',

            data: x[2],

            name: "温度相对值",

            label: {


                position: ['50%', '50%'],

                formatter: '{a}\n\n{c}',			//{a} refers to series name, {b} to data name, and {c} to data value.

                fontSize: 20


            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'


                }

            }

        }


    });

    echarts.init(document.getElementById('liquid4')).setOption({


        series: {

            type: 'liquidFill',

            data: x[3],

            name: "温度相对值",

            label: {


                position: ['50%', '50%'],

                formatter: '{a}\n\n{c}',			//{a} refers to series name, {b} to data name, and {c} to data value.

                fontSize: 20


            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'


                }

            }

        }


    });

    setTimeout(function () {					//之后数据传输时要将此替换（为了模拟数据到来）

            changec(x);

        }, 100
    )
}
</script>

<script type="text/javascript"> 			//百度地图设置

var map = new BMap.Map("container");

// 创建地图实例

var point = new BMap.Point(116.404, 39.915);

// 创建点坐标

map.centerAndZoom(point, 15);					// 初始化地图，设置中心点坐标和地图级别

map.enableScrollWheelZoom(true);

map.disableDoubleClickZoom();

var markersArray = [];

map.setMapStyleV2({

    styleId: '7b1d087644685621c5642aa7841a7956',

});

map.addEventListener("tilesloaded",function(){
    $("#middle").css("display", "none");

});   //loading结束





/*function clearOverlays() {

if (markersArray) {

  for (i in markersArray) {

    map.removeOverlay(markersArray[i])

  }

}

}

//地图上标注

function addMarker(point1) {

var marker = new BMap.Marker(point1);

markersArray.push(marker);

clearOverlays();

map.addOverlay(marker);

}*/

/*function addp() {

    map.addEventListener("click",function(e){
        var r=confirm("起点设置为!" +e.point.lng + "," + e.point.lat);
        if (r==true){

        }
        else{

        }
    });

}*/

/*function delp(){

    var delid=prompt("请输入删除管道段的id","124");
    if (delid!=null && delid!=""){

    }
}
*/
function jump(){
    var jumps = new BMap.Point(document.getElementById('lng').value, document.getElementById('lat').value);
    var r=confirm("是否添加标记");
    map.panTo(jumps);
    if (r==true){
        var marker = new BMap.Marker(jumps);
        map.addOverlay(marker);
    }
}

//点击地图时间处理

function showInfos(content,e) {

    var p = e.target;

    var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);

    //var points1 = new BMap.Point(pos[0], pos[1]);

    var opts = {
        width : 200,     // 信息窗口宽度
        height: 150,     // 信息窗口高度
        title : "传感器信息" , // 信息窗口标题
        enableMessage:true,//设置允许信息窗发送短息
        enableCloseOnClick:false,
        message:"1234321~"
    }



    var infoWindow = new BMap.InfoWindow(content, opts);
    //预留给弹窗显示信息用

    map.openInfoWindow(infoWindow,point); //开启信息窗口

    infoWindow.addEventListener("open",x( infoWindow));

}

function drawpipe(start,end) {

    var ss = start.innerHTML.split(",");
    var ee = end.innerHTML.split(",");
    var points1 = new BMap.Point(ss[0], ss[1]);
    var points2 = new BMap.Point(ee[0], ee[1]);
    var pipeline = new BMap.Polyline([
        points1,
        points2
    ], {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0.5});   //创建折线
    map.addOverlay(pipeline);

}

function drawsensor(id,location,type,state,value,update,creat) {

    var sen = location.innerHTML.split(",");

    var sens = new BMap.Point(sen[0], sen[1]);

    var marker = new BMap.Marker(new BMap.Point(sen[0], sen[1]));			//加载单个点

    var circle1 = new BMap.Circle(sens, 500, {strokeColor: "blue", strokeWeight: 2, strokeOpacity: 0, fillOpacity: 0}); //创建圆

    map.addOverlay(marker);

    map.addOverlay(circle1);

    var content = "id ：" + id.innerHTML + "； 位置 ：" + location.innerHTML + "； 状态 ：" + state.innerHTML + "； 种类 ：" + type.innerHTML + "； 数值 ：" + value.innerHTML +
        "； 更新时间： " + update.innerHTML + "； 创建时间：" + creat.innerHTML;
    addClickHandler(content,marker);
}
function addClickHandler(content,marker){
    marker.addEventListener("click", function(e){
        showInfos(content,e)});

}
</script>

<script th:inline="javascript">

    //写一个循环体，根据告警点数的多少决定加多少个p

    //for(var i=0;i<badnode.length;i++){

    var para=document.createElement("p");

    var badnodeid=  [[${badnodeid}]];

    console.log(badnodeid);

    var node=document.createTextNode(badnodeid);

    para.appendChild(node);

    var element=document.getElementById("dragon");

    element.appendChild(para);



</script>

<script>

    function change(n)

    {

        map.setZoom(6);

        switch(n)

        {

            case 1:

                point = new BMap.Point(119.861811,38.611712);

                map.panTo(point);

                break;

            case 2:

                point = new BMap.Point(120.611501,34.976702);

                map.panTo(point);

                break;

            case 3:

                point = new BMap.Point(122.197347,28.116691);

                map.panTo(point);

                break;

            case 4:

                var point = new BMap.Point(115.004004,11.655103);

                map.panTo(point);

                break;

            case 5:

                var point = new BMap.Point(121.479853,31.232993);

                map.panTo(point);

                break;

            default:

                var point = new BMap.Point(116.404, 39.915);

                map.panTo(point);

        }

    }

</script>



</body>

</html>