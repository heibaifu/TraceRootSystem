<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

<head>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <title>bmaptest</title>

    <link href="/traceroot/css/style.css" rel="stylesheet" type="text/css">

    <link href="https://cdn.bootcss.com/font-awesome/5.8.0/css/all.css" rel="stylesheet" />

    <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=nBKX588I9lDCyaKBip9bQTpmeeCidwL3">

        //v2.0版本的引用方式：src="http://api.map.baidu.com/api?v=2.0&ak=您的密钥"

    </script>



    <script src="/traceroot/js/echarts.min.js"></script>

    <script src="/traceroot/js/echarts-liquidfill.min.js "></script>

    <script type="text/javascript" src="/traceroot/js/changec.js"></script>

    <script type="text/javascript" src="/traceroot/js/jquery-3.3.1.js"></script>

    <script src="/traceroot/js/transdata.js"></script>

    <script>
        function getvalue()
    {
        var pare=window.opener;
        if(pare!=null)
        {

            var start=new Array();
            var end=new Array();
            var update=new Array();
            var creat=new Array();
            var sensorid=new Array();
            var sensorlocation=new Array();
            var sensortype=new Array();
            var sensorstate=new Array();
            var sensorvalue=new Array();
            var sensorupdate=new Array();
            var sensorcreat=new Array();
            var badnodeid=new Array();
            var badnodestart=new Array();
            var badnodeend=new Array();
            var boatid=new Array();
            var boatlocation=new Array();
            var boattype=new Array();
            var boatstate=new Array();
            var boatupdate=new Array();
            var boatcreat=new Array();
            var tablepipesegment=pare.document.getElementById("pipesegment1");
            var tablesensor=pare.document.getElementById("sensor1");
            var tablebadnode=pare.document.getElementById("badnode");
            var tableboat=pare.document.getElementById("boat1");
            chartdata1=tablepipesegment.rows.length-tablebadnode.rows.length;
            chartdata2=tablebadnode.rows.length -1;

            showchart(chartdata1,chartdata2);
           for (i = 0; i < tablepipesegment.rows.length -1; i++) {
                start[i] = tablepipesegment.rows[i+1].cells[1];
                end[i] = tablepipesegment.rows[i+1].cells[2];
                update[i] = tablepipesegment.rows[i+1].cells[3];
                creat[i] = tablepipesegment.rows[i+1].cells[4];
                if (end[i] != null) {

                    drawpipe(start[i], end[i],-1);

                }
            }


            for (j = 0; j <  tablesensor.rows.length -1; j++) {
                sensorid[j] = tablesensor.rows[j+1].cells[0];
                sensorlocation[j] = tablesensor.rows[j+1].cells[1];
                sensortype[j]= tablesensor.rows[j+1].cells[2];
                sensorstate[j]= tablesensor.rows[j+1].cells[3];
                sensorvalue[j]= tablesensor.rows[j+1].cells[4];
                sensorupdate[j]= tablesensor.rows[j+1].cells[5];
                sensorcreat[j]= tablesensor.rows[j+1].cells[6];
                if (sensorlocation[j] != null) {
                    drawsensor(sensorid[j],sensorlocation[j],sensortype[j],sensorstate[j],sensorvalue[j],sensorupdate[j],sensorcreat[j]);

                }
            }

            for (i = 0; i < tablebadnode.rows.length -1; i++) {
                badnodeid[i] = tablebadnode.rows[i+1].cells[0];
                badnodestart[i] = tablebadnode.rows[i+1].cells[1];
                badnodeend[i] = tablebadnode.rows[i+1].cells[2];
                if (badnodeend[i] != null) {

                    drawbadnode(badnodeid[i],badnodestart[i], badnodeend[i]);

                }
            }

            for (j = 0; j <  tableboat.rows.length -1; j++) {
                boatid[j] = tableboat.rows[j+1].cells[0];
                boatlocation[j] = tableboat.rows[j+1].cells[1];
                boattype[j]= tableboat.rows[j+1].cells[2];
                boatstate[j]= tableboat.rows[j+1].cells[3];
                boatupdate[j]= tableboat.rows[j+1].cells[4];
                boatcreat[j]= tableboat.rows[j+1].cells[5];
                if (sensorlocation[j] != null) {
                    drawboat( boatid[j],boatlocation[j],boattype[j],boatstate[j],boatupdate[j],boatcreat[j]);

                }
            }

        }
    }

    </script>

    <script type="text/javascript">
        function finder() {
            var allOverlay = map.getOverlays();
            for (var i = 0; i < allOverlay.length ; i++) {
                if (allOverlay[i].toString()=="[object Polyline]") {
                    if (allOverlay[i].getStrokeStyle() == "dashed")
                        map.removeOverlay(allOverlay[i]);
                }
            }

                find();
            }


            function find() {
                /*修改标签的元素内容*/

                document.getElementById("find").innerHTML = "查找中";
                /*获取标签的值*/
                var id = $("#id").val();
                var data = {
                    'boatid': id
                };
                /* ajax请求*/
                $.ajax({
                    type: "GET",                  // 请求方式
                    url: "/traceroot/boat/findbyboatid",       // 发送请求的地址
                    data: data,                    // 请求参数
                    async: true,                   // 异步请求
                    cache: false,                  // 缓存
                    dataType: "json",              // 返回的数据类型
                    /*请求成功的回调函数*/
                    success: function (result) {
                        if (result.code == 0) {
                            var location = new Array;
                            var ids = result.data[0].boatId;
                            var startt = new Array;
                            for (var i = 0; i < result.data.length - 1; i++) {
                                startt[i] = result.data[i].recordTime;
                                startt[i+1] = result.data[i+1].recordTime;
                                location[i] = result.data[i].recordLocation;
                                location[i + 1] = result.data[i + 1].recordLocation;
                                drawvoyage(ids,location[i], location[i + 1],startt[i],startt[i+1]);
                            }
                        }
                    },
                    /*请求失败的回调函数*/
                    error: function (XMLHttpRequest, textStatus, errorThrown) {

                    }
                });
            }

    </script>

    </head>



<body onload="getvalue()" >

<div style="position:relative; width:100%; height:100%;" id="container"></div>

<div id="middle" class="middle">					<!--loading效果-->



    <div class="bar bar1"></div>



    <div class="bar bar2"></div>



    <div class="bar bar3"></div>



    <div class="bar bar4"></div>



    <div class="bar bar5"></div>



    <div class="bar bar6"></div>



    <div class="bar bar7"></div>



    <div class="bar bar8"></div>



</div>

<div id="navigator">

    <div class="has_children">

        <li onclick=change(0)>管道线路管理</li>

        <li onclick="change(6)">船只线路管理</li>

        <li onclick=change(1)>渤海</li>

        <li onclick=change(2)>黄海</li>

        <li onclick=change(3)>东海</li>

        <li onclick=change(4)>南海</li>

        <li onclick=change(5)>城市管道</li>

    </div>

    <!--<div id="boat" class="has_children">

    <span>船只轨迹监测</span>

     <li onclick=change(6)></li>

     <li onclick=change(7)></li>

     <li onclick=change(8)></li>

    </div> -->

    <div id="echarts" style="width:100%;height:70%;">

    </div>

</div>

<div id="drag">

    <p>告警管道id</p>

    <div id="dragon" class="dragon">

        <!--根据告警管道的个数决定显示多少个p-->

    </div>

</div>

<div id="liquid" >

    <div class="liquid">

        <table cellspacing="1" cellpadding="3" width="30%" style="color: beige" >

            <tr>

                <td>经度</td>

                <td><input type="text" name="lng" id="lng" value=""/>

                </td>

            </tr>

            <tr>

                <td >纬度</td>

                <td><input type="text" name="lat" id="lat" value=""/>

                </td>

            </tr>

            <tr>

                <td >id</td>

                <td><input type="text" name="id" id="id" value=""/>

                </td>

            </tr>

        </table>
        <input type="button" onclick="jump()" value="跳转">
        <input type="button" id="find" onclick="finder()" value="查找路径">

    </div>

    <div id="liquid1" class="liquid" ></div>

    <div id="liquid2" class="liquid" ></div>

    <div id="liquid3" class="liquid" ></div>

    <div id="liquid4" class="liquid" ></div>

    <div class="liquid" name="pipesegment" id="pipesegment">
        <table cellspacing="1" cellpadding="2" width="60%" style="color: beige" >

            <tr  >
                <td>更新时间</td>
                <td><input type="text"   name="pipesegmentstart" id="pipesegmentstart" />
                </td>
            </tr>
            <tr >
                <td>创建时间</td>
                <td><input type="text" name="pipesegmentend" id="pipesegmentend" />
                </td>
            </tr>
        </table>
    </div>

</div>

<div id="button">
    <button style="font-size:24px">新建 <i class="fa fa-plus-square" onclick="addp()"></i></button>
    <button style="font-size:24px">删除 <i class="fa fa-minus-square" onclick="delp()"></i></button>
</div>

<div id="r-result"></div>

<script type="text/javascript">

    // 基于准备好的dom，初始化echarts实例

    function showchart(chartdata1,chartdata2) {

        echarts.init(document.getElementById('echarts')).setOption({

            title: {

                text: '管道情况统计'

            },

            tooltip: {},

            legend: {

                data: ['销量']

            },

            xAxis: {

                data: ["正常管道", "告警管道"],

                axisLine: {

                    lineStyle: {

                        color: 'yellow',					 //设置坐标轴字体颜色

                    }

                }

            },

            yAxis: {


                axisLine: {

                    lineStyle: {

                        color: 'yellow',					 //设置坐标轴字体颜色

                    }

                }

            },


            series: [{

                name: '管道',

                type: 'bar',

                itemStyle: {normal: {color: 'blue'}},							 //设置柱状图颜色

                data: [chartdata1, chartdata2]												//此处需要告警管道的个数

            }]

        });
    }
function showchart2() {
    echarts.init(document.getElementById('echarts')).setOption({


        title: {
            text: '当前管道船只穿越统计',
            x: 'center'
        },
        series: [
            {
                name: '船只类型',
                type: 'pie',
                data: [
                    {value: 35, name: '大型船只'},
                    {value: 101, name: '中型船只'},
                    {value: 234, name: '小型船只'},
                    {value: 13, name: '特大型船只'}
                ],
                label: {
                    normal: {
                        show: true,
                        formatter: '{b}:{c}' + '\n\r' + '({d}%)'
                    }
                }

            }
        ]
    });
}

</script>

<script type="text/javascript">	 //管道参数数据显示

function x(infoWindow) {
    var x = new Array();   //管道参数数据

    var sensordata = infoWindow.getContent();

    var sensorvalue = sensordata.split("；");

    var senid = sensorvalue[0].split("：");

    var location  = sensorvalue[1].split("：");

    var pos  = location[1].split(",");

    var updatet=sensorvalue[5].split("：");

    var creatt=sensorvalue[6].split("：");

    var svalue=sensorvalue[4].split("：");

    var stype=sensorvalue[3].split("：");

    document.getElementById('lng').value = pos[0];

    document.getElementById('lat').value = pos[1];

    document.getElementById('id').value = senid[1];

    document.getElementById("pipesegmentstart").value=updatet[1];

    document.getElementById("pipesegmentend").value=creatt[1];

    var s = parseFloat(svalue[1]);

    var st = parseFloat(stype[1]);

    switch (st) {
        case 2926155 :
            x[0] = [s];
            x[1] = [0];
            x[2] = [0];
            x[3] = [0];
            break;
        case 2926378 :
            x[0] = [0];
            x[1] = [s];
            x[2] = [0];
            x[3] = [0];
            break;
        case 7752109 :
            x[0] = [0];
            x[1] = [0];
            x[2] = [s];
            x[3] = [0];
            break;
        default :
            x[0] = [0];
            x[1] = [0];
            x[2] = [0];
            x[3] = [0.4];
            break;

    }

    echarts.init(document.getElementById('liquid1')).setOption({

        series: {

            type: 'liquidFill',

            data: x[0],

            name: "线路负载",

            label: {

                position: ['50%', '50%'],

                formatter: '{a}\n{b}\n{c}',

                fontSize: 20

            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'

                }

            }

        }

    });

    echarts.init(document.getElementById('liquid2')).setOption({

        series: {

            type: 'liquidFill',

            data: x[1],

            name: "温度相对值",

            label: {

                position: ['50%', '50%'],

                formatter: '{a}\n\n{c}',			//{a} refers to series name, {b} to data name, and {c} to data value.

                fontSize: 20

            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'

                }

            }

        }

    });

    echarts.init(document.getElementById('liquid3')).setOption({

        series: {

            type: 'liquidFill',

            data: x[2],

            name: "温度相对值",

            label: {

                position: ['50%', '50%'],

                formatter: '{a}\n\n{c}',			//{a} refers to series name, {b} to data name, and {c} to data value.

                fontSize: 20

            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'

                }

            }

        }

    });

    echarts.init(document.getElementById('liquid4')).setOption({

        series: {

            type: 'liquidFill',

            data: x[3],

            name: "温度相对值",

            label: {

                position: ['50%', '50%'],

                formatter: '{a}\n\n{c}',			//{a} refers to series name, {b} to data name, and {c} to data value.

                fontSize: 20

            },

            outline: {

                borderDistance: 0,

                itemStyle: {

                    borderWidth: 5,

                    borderColor: '#333'

                }

            }

        }

    });

    setTimeout(function () {					//之后数据传输时要将此替换（为了模拟数据到来）

            changec(x);

        }, 100
    )
}
</script>

<script type="text/javascript"> 			//百度地图设置

var map = new BMap.Map("container");

// 创建地图实例

var point = new BMap.Point(116.404, 39.915);

// 创建点坐标

map.centerAndZoom(point, 15);					// 初始化地图，设置中心点坐标和地图级别

map.enableScrollWheelZoom(true);

map.disableDoubleClickZoom();

var markersArray = [];

map.setMapStyleV2({

    styleId: '7b1d087644685621c5642aa7841a7956',

});

map.addEventListener("tilesloaded",function(){
    $("#middle").css("display", "none");

});   //loading结束

/*
function addp() {

    map.addEventListener("click",function(e){
        var r=confirm("起点设置为!" +e.point.lng + "," + e.point.lat);
        if (r==true){
            var final=prompt("请输入加入管道段的终点","116.000,39.600");
            if (final!=null && final!=""){

        }}
        else{

        }
    });

}
*/
/*function delp(){

    var delid=prompt("请输入删除管道段的id","124");
    if (delid!=null && delid!=""){

    }
}
*/
function jump(){
    var jumps = new BMap.Point(document.getElementById('lng').value, document.getElementById('lat').value);
    var r=confirm("是否添加标记");
    map.panTo(jumps);
    if (r==true){
        var marker = new BMap.Marker(jumps);
        map.addOverlay(marker);
    }
}

function tojump(ss,ee){
    var jumps=new BMap.Point(ss[0]*0.5+ee[0]*0.5, ss[1]*0.5+ee[1]*0.5);
    map.panTo(jumps);
    var marker = new BMap.Marker(jumps);
    map.addOverlay(marker);
    marker.setAnimation(BMAP_ANIMATION_BOUNCE);
}

//点击地图时间处理

function showInfos(content,e,t) {

    var p = e.target;

    var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);

    //var points1 = new BMap.Point(pos[0], pos[1]);
    if (t == 1) {

    var opts = {
        width: 200,     // 信息窗口宽度
        height: 150,     // 信息窗口高度
        title: "传感器信息", // 信息窗口标题
        enableMessage: true,//设置允许信息窗发送短息
        enableCloseOnClick: false,
        message: "1234321~"
    };

    var infoWindow = new BMap.InfoWindow(content, opts);
    //预留给弹窗显示信息用

    map.openInfoWindow(infoWindow, point); //开启信息窗口


        infoWindow.addEventListener("open", x(infoWindow));

    }
    else{
        var opts = {
            width: 200,     // 信息窗口宽度
            height: 150,     // 信息窗口高度
            title: "船只信息", // 信息窗口标题
            enableMessage: true,//设置允许信息窗发送短息
            enableCloseOnClick: false,
            message: "1234321~"
        };

        var infoWindow = new BMap.InfoWindow(content, opts);
        //预留给弹窗显示信息用

        map.openInfoWindow(infoWindow, point); //开启信息窗口

        var boatvalue = content.split("；");

        var bid = boatvalue[0].split("：");

        var lo = boatvalue[1].split("：");

        var pos =lo[1].split(",");

        document.getElementById('id').value = bid[1];

        document.getElementById('lng').value = pos[0];

        document.getElementById('lat').value = pos[1];

    }
}

function showvoya(content,t){
    var opts = {
        width: 200,     // 信息窗口宽度
        height: 200,     // 信息窗口高度
        title: "轨迹信息", // 信息窗口标题
        enableMessage: true,//设置允许信息窗发送短息
        enableCloseOnClick: false,
        message: "1234321~"
    };

    var infoWindow = new BMap.InfoWindow(content, opts);
    //预留给弹窗显示信息用

    map.openInfoWindow(infoWindow, t); //开启信息窗口

}



function addClickHandler(content,marker,t){
    if (t == 1) {
        marker.addEventListener("click", function(e){
            showInfos(content,e,1)});
    }   else {
        marker.addEventListener("click", function(e){
            showInfos(content,e,0)});
    }

}

function addClickHandlerv(content,voyageline,showvl){

        voyageline.addEventListener("click", function(){
            showvoya(content,showvl);})
}


/*function addClickHandlerv(voyageline) {               //点击轨迹删除该轨迹

    voyageline.addEventListener("click", function(){

        map.removeOverlay(voyageline);

    });

}
*/


function drawpipe(start,end,t) {
    if (t == -1) {
        var ss = start.innerHTML.split(",");
        var ee = end.innerHTML.split(",");
        var points1 = new BMap.Point(ss[0], ss[1]);
        var points2 = new BMap.Point(ee[0], ee[1]);


        var pipeline = new BMap.Polyline([
            points1,
            points2
        ], {strokeColor: "blue", strokeStyle: "solid", strokeWeight: 5, strokeOpacity: 0.5});   //创建折线
        map.addOverlay(pipeline);
    }
}
function drawvoyage(ids,start,end,update,creat)
{
    ss = start.split(",");
    ee = end.split(",");
    points1 = new BMap.Point(ss[0], ss[1]);
    points2 = new BMap.Point(ee[0], ee[1]);
    var showvl = new BMap.Point(ss[0]*0.5+ee[0]*0.5, ss[1]*0.5+ee[1]*0.5);
    var voyageline = new BMap.Polyline([
        points1,
        points2
    ], {strokeColor: "green",strokeStyle: "dashed", strokeWeight: 8, strokeOpacity: 0.5});   //创建折线

    var content = "船只id ：" + ids + "； 起点位置 ：" + start +"； 终点位置 ：" + end +
        "； 出发时间： " + update + "； 到达时间：" + creat;
    addClickHandlerv(content,voyageline,showvl);

    map.addOverlay(voyageline);

}


function drawbadnode(id,start,end) {

    var ss = start.innerHTML.split(",");
    var ee = end.innerHTML.split(",");
    var points1 = new BMap.Point(ss[0], ss[1]);
    var points2 = new BMap.Point(ee[0], ee[1]);
    var pipeline = new BMap.Polyline([
        points1,
        points2
    ], {strokeColor: "red", strokeWeight: 5, strokeOpacity: 0.5});   //创建折线

    map.addOverlay(pipeline);

    var para=document.createElement("p");

    var badnoid=id.innerHTML;

    var node=document.createTextNode(badnoid);

    para.appendChild(node);

    para.onclick = function() {            //element.onclick后面直接跟的函数不能有参数
        //每次点击都会画一个标签（小bug）
        tojump(ss, ee);
    }

    var element=document.getElementById("dragon");

    element.appendChild(para);

}

function drawsensor(id,location,type,state,value,update,creat) {

    var sen = location.innerHTML.split(",");

    var myIcon = new BMap.Icon("/traceroot/image/chuanganqic.png", new BMap.Size(32,32));

    var marker = new BMap.Marker(new BMap.Point(sen[0], sen[1]),{icon:myIcon});			//加载单个点

    map.addOverlay(marker);

    var content = "id ：" + id.innerHTML + "； 位置 ：" + location.innerHTML + "； 状态 ：" + state.innerHTML + "； 种类 ：" + type.innerHTML + "； 数值 ：" + value.innerHTML +
        "； 更新时间： " + update.innerHTML + "； 创建时间：" + creat.innerHTML;
    addClickHandler(content,marker,1);
}


function drawboat(id,location,type,state,update,creat) {

    var sen = location.innerHTML.split(",");

    var myIcon = new BMap.Icon("/traceroot/image/boat.png", new BMap.Size(32,32));

    var marker = new BMap.Marker(new BMap.Point(sen[0], sen[1]),{icon:myIcon});			//加载单个点

    map.addOverlay(marker);

    var content = "id ：" + id.innerHTML + "； 位置 ：" + location.innerHTML + "； 状态 ：" + state.innerHTML + "； 种类 ：" + type.innerHTML +
        "； 更新时间： " + update.innerHTML + "； 创建时间：" + creat.innerHTML;
    addClickHandler(content,marker,0);
}

</script>

<script>

    function change(n)

    {

        map.setZoom(6);

        switch(n)

        {

            case 0:

                showchart(chartdata1,chartdata2);

                break;

            case 1:

                var point = new BMap.Point(119.861811,38.611712);

                map.panTo(point);

                break;

            case 2:

                var point = new BMap.Point(120.611501,34.976702);

                map.panTo(point);

                break;

            case 3:

                var point = new BMap.Point(122.197347,28.116691);

                map.panTo(point);

                break;

            case 4:

                var point = new BMap.Point(115.004004,11.655103);

                map.panTo(point);

                break;

            case 5:

                var point = new BMap.Point(121.479853,31.232993);

                map.panTo(point);

                break;

            case 6:

                showchart2();

                break;

            default:

                var point = new BMap.Point(116.404, 39.915);

                map.panTo(point);

        }

    }

</script>



</body>

</html>